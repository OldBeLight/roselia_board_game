<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶é­”ä¹‹è·¯</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Microsoft YaHei', sans-serif;
            background: #222;
        }

        #game-container {
            display: flex;
            height: 100vh;
            filter: blur(0px);
            transition: 0.3s;
        }

        #canvas-container {
            flex: 1;
            overflow: auto;
            position: relative;
            background: #333;
        }

        canvas {
            display: block;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            cursor: default;
        }

        #sidebar {
            width: 340px;
            background: #f9f9f9;
            padding: 15px;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            z-index: 10;
            height: 100vh;
            box-sizing: border-box;
        }

        h2 {
            margin-top: 0;
            color: #333;
            text-align: center;
            font-size: 20px;
        }

        .room-info {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-bottom: 5px;
            background: #eee;
            padding: 5px;
            border-radius: 4px;
        }

        /* å¤§å…æ ·å¼ */
        .char-select {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-bottom: 5px;
        }

        .char-btn {
            border: 2px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            overflow: hidden;
            height: 50px;
            background: #fff;
        }

        .char-btn img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .char-btn.selected {
            border-color: #e91e63;
            background: #ffe0e9;
        }

        .char-btn.taken {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(100%);
            background: #ddd;
        }

        #waiting-list {
            font-size: 13px;
            color: #555;
            background: #fff;
            padding: 10px;
            border-radius: 5px;
            border: 1px dashed #ccc;
            margin-bottom: 10px;
        }

        /* æ¸¸æˆä¸»åŒºåŸŸ - ä½¿ç”¨ Flex å¸ƒå±€ä½¿å¾—æ—¥å¿—å¯ä»¥å æ®å‰©ä½™ç©ºé—´ */
        #status-area {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        #game-ui {
            margin-bottom: 10px;
        }

        .btn {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-primary {
            background: #2196F3;
        }

        .btn-warning {
            background: #FF9800;
            color: #fff;
            font-weight: bold;
        }

        .btn-success {
            background: #4CAF50;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #dice-result {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            color: #e91e63;
            min-height: 25px;
        }

        #turn-indicator {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 10px;
            background: #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .my-turn {
            background: #d1c4e9 !important;
            border: 2px solid #673ab7;
        }

        /* ç§¯åˆ†æ¦œ */
        #score-container {
            margin-bottom: 10px;
        }

        .score-item {
            display: flex;
            align-items: center;
            background: #fff;
            border-bottom: 1px solid #eee;
            padding: 5px;
            font-size: 13px;
        }

        .score-item img {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid #ccc;
        }

        .score-info {
            flex: 1;
        }

        .score-val {
            font-weight: bold;
            color: #E65100;
        }

        .turn-order-badge {
            display: inline-block;
            width: 16px;
            height: 16px;
            text-align: center;
            line-height: 16px;
            background: #333;
            color: #fff;
            border-radius: 50%;
            font-size: 10px;
            margin-right: 5px;
        }

        .btn-xs {
            padding: 2px 6px;
            font-size: 12px;
            background: #607D8B;
            width: auto;
            margin-top: 0;
        }

        /* æ—¥å¿—åŒºåŸŸ */
        #game-log {
            flex: 1;
            background: #222;
            color: #eee;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            overflow-y: auto;
            font-family: monospace;
            border: 2px solid #555;
        }

        .log-entry {
            margin-bottom: 5px;
            line-height: 1.4;
            border-bottom: 1px dashed #444;
            padding-bottom: 2px;
        }

        .log-time {
            color: #888;
            margin-right: 5px;
        }

        .log-card {
            color: #FFEB3B;
            font-weight: bold;
        }

        .log-player {
            color: #4FC3F7;
            font-weight: bold;
        }

        #ad-area { margin-top: auto; padding-top: 15px; border-top: 2px solid #ddd; text-align: center; }

        .ad-link {
            display: inline-block;
            width: 45%;
            padding: 5px;
            background: #ffeb3b;
            color: #d81b60;
            text-decoration: none;
            font-weight: bold;
            border-radius: 5px;
            font-size: 12px;
            margin: 0 2px;
        }

        /* å¡ç‰‡å¼¹çª— */
        #card-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        .card-content {
            background: #fff;
            width: 300px;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 5px solid #fff;
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.2);
            position: relative;
            transform: scale(0.8);
            animation: popIn 0.5s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .card-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .card-desc {
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 20px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-close-btn {
            background: #333;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes popIn {
            to {
                transform: scale(1);
            }
        }

        /* ç™»å½•å±‚ */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 300px;
            text-align: center;
        }

        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }

        .login-btns {
            display: flex;
            gap: 10px;
        }
    </style>
</head>

<body>

    <!-- æŠ½å¡å¼¹çª— -->
    <div id="card-modal">
        <div class="card-content" id="card-inner">
            <div class="card-title" id="card-title">å¡ç‰‡åç§°</div>
            <div class="card-desc" id="card-desc">å¡ç‰‡æ•ˆæœæè¿°</div>
            <button class="card-close-btn" onclick="closeCardModal()">ç¡®è®¤ / çŸ¥é“äº†</button>
        </div>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <h1>æ¶é­”ä¹‹è·¯</h1>
            <div class="input-group">
                <label>æˆ¿é—´å·</label><input type="text" id="room-id" placeholder="roselia">
            </div>
            <div class="input-group">
                <label>å¯†ç </label><input type="password" id="room-pass" placeholder="å¯é€‰">
            </div>
            <div class="login-btns">
                <button class="btn btn-primary" onclick="doJoin()">åŠ å…¥</button>
                <button class="btn btn-success" onclick="doCreate()">åˆ›å»º</button>
            </div>
            <div style="color:red; margin-top:10px" id="login-msg"></div>
        </div>
    </div>

    <div id="game-container">
        <div id="canvas-container"><canvas id="gameCanvas"></canvas></div>
        <div id="sidebar">
            <h2>æ¶é­”ä¹‹è·¯</h2>
            <div class="room-info" id="room-display">æœªè¿æ¥</div>

            <div id="status-area">
                <div id="lobby-ui">
                    <p>ç‚¹å‡»å¤´åƒé€‰æ‹©è§’è‰²:</p>
                    <div class="char-select" id="char-list"></div>
                    <div id="waiting-list"></div>
                    <button id="start-btn" class="btn btn-primary" disabled>å¼€å§‹æ¸¸æˆ</button>
                </div>

                <div id="game-ui" style="display: none;">
                    <div id="turn-indicator">ç­‰å¾…å¼€å§‹...</div>

                    <div id="controls">
                        <div style="display:flex; gap:5px; margin-bottom: 5px;">
                            <button class="btn btn-primary" onclick="rollDice(1)">ğŸ² 1ä¸ª</button>
                            <button class="btn btn-primary" onclick="rollDice(2)">ğŸ² 2ä¸ª</button>
                        </div>
                        <!-- æ–°å¢æŠ½å¡æŒ‰é’® -->
                        <button class="btn btn-warning" onclick="drawCard()">ğŸƒ æŠ½å¡ (Card)</button>
                    </div>

                    <div id="dice-result"></div>
                    <button id="end-turn-btn" class="btn btn-success" onclick="endTurn()" disabled>ç»“æŸå›åˆ</button>
                    <p id="spectator-msg" style="color:#e91e63; display:none; text-align:center; font-size:12px;">è§‚æˆ˜æ¨¡å¼
                    </p>
                </div>

                <div id="score-container">
                    <div
                        style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #ddd; padding-bottom:5px; margin-bottom:5px;">
                        <strong style="font-size:14px;">è§’è‰²ä¸å¯å´©ç‚¹æ•°</strong>
                    </div>
                    <div id="score-list"></div>
                </div>

                <!-- æ¸¸æˆæ—¥å¿— -->
                <div id="game-log">
                    <div class="log-entry" style="color:#aaa">æ¬¢è¿æ¥åˆ° æ¶é­”ä¹‹è·¯ï¼è¯·ç•™æ„æ­¤å¤„æ—¥å¿—ã€‚</div>
                </div>
            </div>

            <div id="ad-area">
                <a href="https://docs.qq.com/markdown/DTENqRVpxR0tUeFNE" target="_blank" class="ad-link">è§„åˆ™ä¹¦ï¼ˆå›½å†…å¯è®¿é—®ï¼‰</a>
                <a href="https://github.com/ChenViVi/roselia_board_game/" target="_blank" class="ad-link">Githubé¡¹ç›®åœ°å€</a>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const mapImg = new Image(); mapImg.src = 'map.png';
        const charImgs = {};
        for (let i = 1; i <= 5; i++) { charImgs[i] = new Image(); charImgs[i].src = `char${i}.png`; }

        let myId = null;
        let myCharId = null;
        let players = {};
        let playerOrder = [];
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let currentTurnId = null;
        let isGameRunning = false;

        mapImg.onload = () => { canvas.width = mapImg.width; canvas.height = mapImg.height; draw(); };

        // --- Socket ---
        socket.on('connect', () => { myId = socket.id; });
        socket.on('err', (msg) => { document.getElementById('login-msg').innerText = msg; });

        socket.on('roomJoined', (data) => {
            players = data.players;
            isGameRunning = data.gameStarted;
            playerOrder = data.playerOrder || [];
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('room-display').innerText = `Room: ${data.roomId}`;

            if (!isGameRunning) updateLobby(data.takenChars);
            updateScoreBoard();
            if (isGameRunning) {
                switchToGameUI();
                updateTurn(data.currentTurn);
                addLog("ç³»ç»Ÿ", "æ‚¨å·²é‡æ–°è¿æ¥æˆ–åŠ å…¥è§‚æˆ˜ã€‚");
            }
            draw();
        });

        socket.on('updatePlayers', (serverPlayers) => {
            players = serverPlayers;
            if (!isGameRunning) updateLobby(Object.values(players).map(p => p.charId));

            const count = Object.keys(players).length;
            const startBtn = document.getElementById('start-btn');
            if (myCharId) {
                startBtn.disabled = count < 2;
                startBtn.innerText = count >= 2 ? `å¼€å§‹ (${count}äºº)` : `ç­‰äºº...`;
            }
            updateScoreBoard();
            draw();
        });

        socket.on('takenChars', (list) => { if (!isGameRunning) updateLobby(list); });

        socket.on('gameStarted', (data) => {
            isGameRunning = true;
            playerOrder = data.playerOrder;
            addLog("ç³»ç»Ÿ", `æ¸¸æˆå¼€å§‹ï¼éšæœºé¡ºåºå·²å†³å®šã€‚`);
            switchToGameUI();
            updateTurn(data.currentTurn);
            updateScoreBoard();
        });

        socket.on('diceRolled', (data) => {
            const pName = getPlayerName(data.player);
            document.getElementById('dice-result').innerText = `ğŸ² ${data.roll}`;
            addLog(pName, `æŠ•æ·äº† ${data.details.join('+')} = ${data.roll} ç‚¹`);

            if (data.player === myId) {
                document.getElementById('end-turn-btn').disabled = false;
                // ç¦ç”¨æŠ•éª°å­å’ŒæŠ½å¡ï¼Œé˜²æ­¢é‡å¤æ“ä½œ
                document.querySelectorAll('#controls button').forEach(b => b.disabled = true);
            }
        });

        // --- æ ¸å¿ƒï¼šæŠ½å¡ç»“æœå¤„ç† ---
        socket.on('cardResult', (data) => {
            const pName = getPlayerName(data.player);
            const card = data.card;

            // 1. å†™å…¥æ—¥å¿—
            addLog(pName, `æŠ½åˆ°äº†å¡ç‰‡ï¼š${card.name}`);
            addLog("æ•ˆæœ", card.desc);

            // 2. æ˜¾ç¤ºå¼¹çª—
            showCardModal(card.name, card.desc, card.color);

            // 3. å¦‚æœæ˜¯è‡ªå·±ï¼Œå…è®¸ç»“æŸå›åˆï¼ˆä¹Ÿå¯ä»¥è®¾å®šæŠ½å¡åè¿˜èƒ½åšåˆ«çš„ï¼Œè¿™é‡Œç®€å•å¤„ç†è§†ä¸ºè¡ŒåŠ¨çš„ä¸€éƒ¨åˆ†ï¼‰
            // æŒ‰ç…§é€»è¾‘ï¼ŒæŠ½å¡é€šå¸¸åœ¨ç§»åŠ¨åæˆ–ä»£æ›¿ç§»åŠ¨ï¼Œè¿™é‡Œå‡è®¾ç©å®¶å¯ä»¥åœ¨ä»»ä½•æ—¶å€™æŠ½
            // ä½†é€šå¸¸ä¸ºäº†é˜²æ­¢è¯¯æ“ä½œï¼Œè¿™é‡Œä¿æŒâ€œç»“æŸå›åˆâ€æŒ‰é’®å¯ç”¨çŠ¶æ€ä¸å˜
        });

        socket.on('log', (data) => { addLog("ç³»ç»Ÿ", data.text); });

        socket.on('turnChanged', (data) => { updateTurn(data.currentTurn); });
        socket.on('playerMoved', (data) => {
            if (players[data.id]) { players[data.id].x = data.x; players[data.id].y = data.y; draw(); }
        });
        socket.on('changeScore', (data) => { /* Score update handled by updatePlayers */ });
        socket.on('gameReset', (msg) => { alert(msg); location.reload(); });

        // --- UI Logic ---
        function doCreate() {
            const r = document.getElementById('room-id').value;
            const p = document.getElementById('room-pass').value;
            if (r) socket.emit('createRoom', { roomId: r, password: p });
        }
        function doJoin() {
            const r = document.getElementById('room-id').value;
            const p = document.getElementById('room-pass').value;
            if (r) socket.emit('joinRoom', { roomId: r, password: p });
        }
        function selectChar(id) {
            if (myCharId || isGameRunning) return;
            socket.emit('selectCharacter', id);
            myCharId = id;
            canvas.style.cursor = 'grab';
            updateSelectionHighlight(id);
        }
        function updateSelectionHighlight(id) {
            document.querySelectorAll('.char-btn').forEach(b => b.classList.remove('selected'));
            const btn = document.getElementById(`btn-char-${id}`);
            if (btn) btn.classList.add('selected');
        }

        function updateLobby(taken) {
            const list = document.getElementById('char-list');
            list.innerHTML = '';
            if (isGameRunning && !myCharId) {
                list.innerHTML = '<div style="grid-column:1/-1;text-align:center;font-size:12px;color:#999;">è§‚æˆ˜ä¸­</div>';
            } else {
                for (let i = 1; i <= 5; i++) {
                    const div = document.createElement('div');
                    div.className = `char-btn ${taken.includes(i) && i !== myCharId ? 'taken' : ''}`;
                    div.id = `btn-char-${i}`;
                    div.innerHTML = `<img src="char${i}.png">`;
                    if ((!taken.includes(i) || i === myCharId) && !isGameRunning) div.onclick = () => selectChar(i);
                    if (i === myCharId) div.classList.add('selected');
                    list.appendChild(div);
                }
            }
            // æ›´æ–°æ–‡å­—åˆ—è¡¨
            const wList = document.getElementById('waiting-list');
            wList.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const row = document.createElement('div');
                row.style.display = 'flex'; row.style.justifyContent = 'space-between';
                row.innerHTML = `<span>è§’è‰²${i}</span> <span>${taken.includes(i) ? 'âœ…' : '...'}</span>`;
                wList.appendChild(row);
            }
        }

        function updateScoreBoard() {
            const list = document.getElementById('score-list');
            list.innerHTML = '';
            let order = isGameRunning && playerOrder.length ? playerOrder.map(id => players[id]).filter(p => p) : Object.values(players);

            order.forEach((p, idx) => {
                const row = document.createElement('div');
                row.className = 'score-item';
                const isMe = p.id === myId;
                const badge = isGameRunning ? `<span class="turn-order-badge">${idx + 1}</span>` : '';
                const btn = isMe ? `<button class="btn btn-xs" onclick="modScore()">ä¿®æ”¹</button>` : '';
                row.innerHTML = `${badge}<img src="char${p.charId}.png"><div class="score-info">è§’è‰²${p.charId} ${isMe ? '(æˆ‘)' : ''}</div><div class="score-val">${p.score}</div>${btn}`;
                list.appendChild(row);
            });
        }

        function switchToGameUI() {
            document.getElementById('lobby-ui').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            if (!myCharId) {
                document.getElementById('controls').style.display = 'none';
                document.getElementById('end-turn-btn').style.display = 'none';
                document.getElementById('spectator-msg').style.display = 'block';
            }
        }

        function updateTurn(turnId) {
            currentTurnId = turnId;
            const isMe = myId === turnId;
            const ind = document.getElementById('turn-indicator');
            document.getElementById('dice-result').innerText = '';
            document.getElementById('end-turn-btn').disabled = true;

            document.querySelectorAll('#controls button').forEach(b => b.disabled = !isMe);

            if (!myCharId) ind.innerText = `å½“å‰: ${getPlayerName(turnId)}`;
            else if (isMe) { ind.innerText = "ğŸ‘‰ ä½ çš„å›åˆ"; ind.className = 'my-turn'; }
            else { ind.innerText = `ç­‰å¾… ${getPlayerName(turnId)}...`; ind.className = ''; }
            draw();
        }

        // --- æ—¥å¿—ä¸è¾…åŠ© ---
        function addLog(who, msg) {
            const log = document.getElementById('game-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit' });
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-player">${who}:</span> ${msg}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function getPlayerName(id) {
            const p = players[id];
            return p ? `è§’è‰²${p.charId}` : 'æœªçŸ¥';
        }

        // --- å¼¹çª—é€»è¾‘ ---
        function showCardModal(title, desc, color) {
            const modal = document.getElementById('card-modal');
            const inner = document.getElementById('card-inner');
            document.getElementById('card-title').innerText = title;
            document.getElementById('card-desc').innerText = desc;
            document.getElementById('card-title').style.color = color || '#333';
            inner.style.borderColor = color || '#fff';
            modal.style.display = 'flex';
        }
        window.closeCardModal = () => { document.getElementById('card-modal').style.display = 'none'; };

        // --- æ“ä½œ ---
        window.rollDice = (n) => { if (myCharId) socket.emit('rollDice', n); };
        window.drawCard = () => { if (myCharId) socket.emit('drawCard'); }; // æ–°å¢
        window.endTurn = () => { if (myCharId) socket.emit('endTurn'); };
        window.modScore = () => {
            const v = prompt("è¾“å…¥å˜åŠ¨å€¼:");
            if (v && !isNaN(parseInt(v))) socket.emit('changeScore', v);
        }
        document.getElementById('start-btn').onclick = () => socket.emit('startGame');

        // --- Canvas & Drag (ä¿æŒä¸å˜) ---
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (mapImg.complete) ctx.drawImage(mapImg, 0, 0);
            Object.values(players).forEach(p => {
                const img = charImgs[p.charId];
                if (img && img.complete) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(p.x + 40, p.y + 40, 45, 0, Math.PI * 2);
                    ctx.fillStyle = p.id === myId ? 'rgba(0,255,0,0.5)' : 'rgba(255,255,255,0.5)';
                    ctx.fill();
                    if (p.id === currentTurnId) { ctx.strokeStyle = '#e91e63'; ctx.lineWidth = 5; ctx.stroke(); }
                    ctx.drawImage(img, p.x, p.y, 80, 80);
                    ctx.fillStyle = "white"; ctx.font = "bold 20px Arial";
                    ctx.strokeStyle = "black"; ctx.lineWidth = 3;
                    ctx.strokeText(`${p.score}`, p.x + 20, p.y - 10); ctx.fillText(`${p.score}`, p.x + 20, p.y - 10);
                    ctx.restore();
                }
            });
        }
        canvas.onmousedown = (e) => {
            if (!myCharId || !players[myId]) return;
            const r = canvas.getBoundingClientRect();
            const sx = canvas.width / r.width, sy = canvas.height / r.height;
            const mx = (e.clientX - r.left) * sx, my = (e.clientY - r.top) * sy;
            const p = players[myId];
            if (mx >= p.x && mx <= p.x + 80 && my >= p.y && my <= p.y + 80) {
                isDragging = true; canvas.style.cursor = 'grabbing';
                dragOffset = { x: mx - p.x, y: my - p.y };
            }
        };
        canvas.onmousemove = (e) => {
            if (!isDragging) return;
            const r = canvas.getBoundingClientRect();
            const mx = (e.clientX - r.left) * (canvas.width / r.width), my = (e.clientY - r.top) * (canvas.height / r.height);
            players[myId].x = mx - dragOffset.x; players[myId].y = my - dragOffset.y;
            draw();
            socket.emit('movePlayer', { x: players[myId].x, y: players[myId].y });
        };
        canvas.onmouseup = () => { isDragging = false; if (myCharId) canvas.style.cursor = 'grab'; };
        function loop() { requestAnimationFrame(loop); } loop();
    </script>
</body>

</html>