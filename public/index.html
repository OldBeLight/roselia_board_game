<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­¦å£«é“å°±æ˜¯æ¶é­”ä¹‹è·¯</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Microsoft YaHei', sans-serif;
            background: #222;
        }

        #game-container {
            display: flex;
            height: 100vh;
        }

        #canvas-container {
            flex: 1;
            overflow: auto;
            position: relative;
            background: #333;
        }

        canvas {
            display: block;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            cursor: grab;
        }

        canvas:active {
            cursor: grabbing;
        }

        #sidebar {
            width: 300px;
            background: #f0f0f0;
            padding: 20px;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }

        .char-select {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .char-btn {
            border: 2px solid #ccc;
            border-radius: 50%;
            cursor: pointer;
            overflow: hidden;
            width: 60px;
            height: 60px;
            transition: 0.2s;
        }

        .char-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .char-btn.selected {
            border-color: #e91e63;
            transform: scale(1.1);
            box-shadow: 0 0 10px #e91e63;
        }

        .char-btn.taken {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        #status-area {
            flex: 1;
        }

        .btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        .btn-primary {
            background: #2196F3;
        }

        .btn-success {
            background: #4CAF50;
        }

        .btn-danger {
            background: #f44336;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #dice-result {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #e91e63;
            height: 40px;
        }

        #turn-indicator {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 10px;
            background: #ddd;
            border-radius: 5px;
        }

        .my-turn {
            background: #d1c4e9 !important;
            border: 2px solid #673ab7;
        }
    </style>
</head>

<body>

    <div id="game-container">
        <div id="canvas-container">
            <canvas id="gameCanvas"></canvas>
        </div>
        <div id="sidebar">
            <h2>æ­¦å£«é“å°±æ˜¯æ¶é­”ä¹‹è·¯</h2>

            <div id="lobby-ui">
                <p>è¯·é€‰æ‹©ä¸€åè§’è‰²:</p>
                <div class="char-select" id="char-list">
                    <!-- JS ç”Ÿæˆ -->
                </div>
                <button id="start-btn" class="btn btn-primary" disabled>å¼€å§‹æ¸¸æˆ (è‡³å°‘2äºº)</button>
            </div>

            <div id="game-ui" style="display: none;">
                <div id="turn-indicator">ç­‰å¾…å¼€å§‹...</div>

                <div id="controls">
                    <p>é€‰æ‹©éª°å­æ•°é‡:</p>
                    <button class="btn btn-primary" onclick="rollDice(1)">æŠ•æ· 1 ä¸ªéª°å­</button>
                    <button class="btn btn-primary" onclick="rollDice(2)">æŠ•æ· 2 ä¸ªéª°å­</button>
                </div>

                <div id="dice-result"></div>
                <button id="end-turn-btn" class="btn btn-success" onclick="endTurn()" disabled>ç»“æŸå›åˆ</button>

                <p style="font-size: 12px; color: #666; margin-top: 20px;">
                    * ç©æ³•æç¤º: æŠ•æ·åï¼Œè¯·ç”¨é¼ æ ‡ç›´æ¥æ‹–æ‹½åœ°å›¾ä¸Šçš„å¤´åƒåˆ°å¯¹åº”æ ¼å­ã€‚é‡åˆ°åˆ†æ”¯è¯·è‡ªè¡Œå†³å®šæ–¹å‘ã€‚
                </p>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // èµ„æº
        const mapImg = new Image();
        mapImg.src = 'map.png';
        const charImgs = {};
        for (let i = 1; i <= 5; i++) {
            charImgs[i] = new Image();
            charImgs[i].src = `char${i}.png`;
        }

        // çŠ¶æ€
        let myId = null;
        let myCharId = null;
        let players = {};
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let gameActive = false;
        let currentTurnId = null;

        // åˆå§‹åŒ– Canvas
        mapImg.onload = () => {
            canvas.width = mapImg.width;
            canvas.height = mapImg.height;
            draw();
        };

        // Socket ç›‘å¬
        socket.on('connect', () => { myId = socket.id; });

        socket.on('init', (data) => {
            players = data.players;
            updateLobby(data.takenChars);
            if (data.gameStarted) switchToGameUI();
            draw();
        });

        socket.on('updatePlayers', (serverPlayers) => {
            players = serverPlayers;
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰è¶³å¤Ÿç©å®¶æ¿€æ´»å¼€å§‹æŒ‰é’®
            const count = Object.keys(players).length;
            document.getElementById('start-btn').disabled = count < 2;
            if (count >= 2) document.getElementById('start-btn').innerText = `å¼€å§‹æ¸¸æˆ (${count}äºº)`;
            else document.getElementById('start-btn').innerText = `ç­‰å¾…ç©å®¶ (${count}/5)`;

            draw();
        });

        socket.on('takenChars', (list) => { updateLobby(list); });

        socket.on('gameStarted', (data) => {
            switchToGameUI();
            updateTurn(data.currentTurn);
        });

        socket.on('diceRolled', (data) => {
            const resultText = document.getElementById('dice-result');
            resultText.innerText = `ğŸ² ${data.details.join(' + ')} = ${data.roll}`;
            if (data.player === myId) {
                document.getElementById('end-turn-btn').disabled = false; // å…è®¸ç»“æŸå›åˆ
                // ç¦ç”¨æŠ•æ·æŒ‰é’®
                document.querySelectorAll('#controls button').forEach(b => b.disabled = true);
            }
        });

        socket.on('turnChanged', (data) => {
            updateTurn(data.currentTurn);
        });

        socket.on('playerMoved', (data) => {
            if (players[data.id]) {
                players[data.id].x = data.x;
                players[data.id].y = data.y;
                draw();
            }
        });

        socket.on('gameReset', () => {
            alert('ç©å®¶é€€å‡ºï¼Œæ¸¸æˆé‡ç½®');
            location.reload();
        });


        // äº¤äº’é€»è¾‘
        function selectChar(id) {
            if (myCharId) return;
            socket.emit('selectCharacter', id);
            myCharId = id;
            // é«˜äº®é€‰æ‹©
            document.querySelectorAll('.char-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById(`btn-char-${id}`).classList.add('selected');
        }

        function updateLobby(takenList) {
            const container = document.getElementById('char-list');
            container.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                const btn = document.createElement('div');
                btn.className = `char-btn ${takenList.includes(i) && i !== myCharId ? 'taken' : ''}`;
                btn.id = `btn-char-${i}`;
                btn.innerHTML = `<img src="char${i}.png">`;
                if (!takenList.includes(i) || i === myCharId) {
                    btn.onclick = () => selectChar(i);
                }
                if (i === myCharId) btn.classList.add('selected');
                container.appendChild(btn);
            }
        }

        document.getElementById('start-btn').onclick = () => {
            socket.emit('startGame');
        };

        function switchToGameUI() {
            gameActive = true;
            document.getElementById('lobby-ui').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
        }

        function updateTurn(turnId) {
            currentTurnId = turnId;
            const isMyTurn = (myId === currentTurnId);
            const indicator = document.getElementById('turn-indicator');
            const diceRes = document.getElementById('dice-result');
            const endBtn = document.getElementById('end-turn-btn');

            diceRes.innerText = '';
            endBtn.disabled = true;

            const buttons = document.querySelectorAll('#controls button');
            buttons.forEach(b => b.disabled = !isMyTurn);

            if (isMyTurn) {
                indicator.innerText = "ğŸ‘‰ è½®åˆ°ä½ äº†ï¼è¯·æŠ•éª°å­";
                indicator.classList.add('my-turn');
            } else {
                // æ‰¾åˆ°å½“å‰ç©å®¶çš„è§’è‰²IDæ¥æ˜¾ç¤ºåå­—ï¼ˆå¦‚æœæœ‰åå­—çš„è¯ï¼Œè¿™é‡Œç”¨IDä»£æ›¿ï¼‰
                indicator.innerText = "â³ ç­‰å¾…å…¶ä»–ç©å®¶è¡ŒåŠ¨...";
                indicator.classList.remove('my-turn');
            }
        }

        window.rollDice = (count) => {
            socket.emit('rollDice', count);
        };

        window.endTurn = () => {
            socket.emit('endTurn');
        };

        // Canvas ç»˜åˆ¶ä¸æ‹–æ‹½
        function draw() {
            // æ¸…ç©º
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ç”»åœ°å›¾
            if (mapImg.complete) ctx.drawImage(mapImg, 0, 0);

            // ç”»ç©å®¶
            Object.values(players).forEach(p => {
                const img = charImgs[p.charId];
                if (img && img.complete) {
                    ctx.save();
                    // ç”»ä¸ªåœˆæ ‡è®°æ˜¯è°
                    ctx.beginPath();
                    ctx.arc(p.x + 40, p.y + 40, 45, 0, Math.PI * 2);
                    ctx.fillStyle = (p.id === myId) ? 'rgba(0, 255, 0, 0.5)' : 'rgba(255, 255, 255, 0.5)';
                    ctx.fill();
                    if (p.id === currentTurnId) {
                        ctx.strokeStyle = '#e91e63';
                        ctx.lineWidth = 5;
                        ctx.stroke();
                    }

                    // ç”»å¤´åƒ (80x80å¤§å°)
                    ctx.drawImage(img, p.x, p.y, 80, 80);
                    ctx.restore();
                }
            });
        }

        // é¼ æ ‡äº‹ä»¶å¤„ç†æ‹–æ‹½
        canvas.onmousedown = (e) => {
            if (!myCharId || !players[myId]) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            const mouseX = (e.clientX - rect.left) * scaleX;
            const mouseY = (e.clientY - rect.top) * scaleY;

            const p = players[myId];
            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†è‡ªå·±çš„å¤´åƒ (80x80åŒºåŸŸ)
            if (mouseX >= p.x && mouseX <= p.x + 80 && mouseY >= p.y && mouseY <= p.y + 80) {
                isDragging = true;
                dragOffset.x = mouseX - p.x;
                dragOffset.y = mouseY - p.y;
            }
        };

        canvas.onmousemove = (e) => {
            if (!isDragging) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            const mouseX = (e.clientX - rect.left) * scaleX;
            const mouseY = (e.clientY - rect.top) * scaleY;

            const newX = mouseX - dragOffset.x;
            const newY = mouseY - dragOffset.y;

            // æœ¬åœ°ç«‹å³æ›´æ–°æ˜¾ç¤º
            players[myId].x = newX;
            players[myId].y = newY;
            draw();

            // å‘é€ä½ç½®ç»™æœåŠ¡å™¨
            socket.emit('movePlayer', { x: newX, y: newY });
        };

        canvas.onmouseup = () => {
            isDragging = false;
        };

        // ç®€å•çš„åŠ¨ç”»å¾ªç¯
        function loop() {
            requestAnimationFrame(loop);
        }
        loop();

    </script>
</body>

</html>